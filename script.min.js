function setModalState(modalId, isOpen) {
    const modal = document.getElementById(modalId);
    if (!modal) {
        return;
    }

    modal.classList.toggle("active", isOpen);

    if (isOpen) {
        document.body.style.overflow = "hidden";
        return;
    }

    const anyOpenModal = document.querySelector(".services-overlay.active, .about-overlay.active, .business-profile-overlay.active, .capability-statement-overlay.active, .technical-capabilities-overlay.active, .portfolio-overlay.active, .legal-regulatory-overlay.active, .transformation-modal-overlay.active");
    if (!anyOpenModal) {
        document.body.style.overflow = "auto";
    }
}

window.openTransformModal = function openTransformModal() {
    setModalState("transformationModal", true);
};

window.closeTransformModal = function closeTransformModal() {
    setModalState("transformationModal", false);
    const formElement = document.getElementById("transformationForm");
    const successMessage = document.getElementById("successMessage");

    if (formElement) {
        formElement.style.display = "block";
        formElement.reset();
    }

    if (successMessage) {
        successMessage.style.display = "none";
    }
};

window.openServices = function openServices() { setModalState("services-modal", true); };
window.closeServices = function closeServices() { setModalState("services-modal", false); };
window.openAbout = function openAbout() { setModalState("about-modal", true); };
window.closeAbout = function closeAbout() { setModalState("about-modal", false); };
window.openBusinessProfile = function openBusinessProfile() { setModalState("business-profile-modal", true); };
window.closeBusinessProfile = function closeBusinessProfile() { setModalState("business-profile-modal", false); };
window.openCapabilityStatement = function openCapabilityStatement() { setModalState("capability-statement-modal", true); };
window.closeCapabilityStatement = function closeCapabilityStatement() { setModalState("capability-statement-modal", false); };
window.openTechnicalCapabilities = function openTechnicalCapabilities() { setModalState("technical-capabilities-modal", true); };
window.closeTechnicalCapabilities = function closeTechnicalCapabilities() { setModalState("technical-capabilities-modal", false); };
window.openPortfolio = function openPortfolio() { setModalState("portfolio-modal", true); };
window.closePortfolio = function closePortfolio() { setModalState("portfolio-modal", false); };
window.openLegalRegulatory = function openLegalRegulatory() { setModalState("legal-regulatory-modal", true); };
window.closeLegalRegulatory = function closeLegalRegulatory() { setModalState("legal-regulatory-modal", false); };

document.addEventListener("DOMContentLoaded", async () => {
    const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
    const isMobile = window.matchMedia("(max-width: 768px)").matches || /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    const particlesEngine = window.particlesJS;
    let particlesHost = document.getElementById("bg");

    if (particlesHost && particlesHost.tagName === "CANVAS") {
        const replacement = document.createElement("div");
        replacement.id = "bg";
        particlesHost.parentNode.replaceChild(replacement, particlesHost);
        particlesHost = replacement;
    }

    if (particlesEngine && particlesHost) {
        const particleCount = prefersReducedMotion ? 18 : (isMobile ? 36 : 64);
        const fpsLimit = prefersReducedMotion ? 18 : (isMobile ? 28 : 34);
        const linkDistance = isMobile ? 105 : 130;

        try {
            particlesEngine("bg", {
                fps_limit: fpsLimit,
                particles: {
                    number: {
                        value: particleCount,
                        density: {
                            enable: true,
                            value_area: isMobile ? 820 : 700
                        }
                    },
                    color: {
                        value: "#2100ee"
                    },
                    shape: {
                        type: "circle"
                    },
                    opacity: {
                        value: 0.5,
                        random: true,
                        anim: {
                            enable: true,
                            speed: 1.2,
                            opacity_min: 0.2,
                            sync: false
                        }
                    },
                    size: {
                        value: 2.4,
                        random: true,
                        anim: {
                            enable: true,
                            speed: 2,
                            size_min: 0.6,
                            sync: false
                        }
                    },
                    line_linked: {
                        enable: true,
                        distance: linkDistance,
                        color: "#1e3a8a",
                        opacity: 0.25,
                        width: 1
                    },
                    move: {
                        enable: true,
                        speed: isMobile ? 0.9 : 1.35,
                        direction: "none",
                        random: true,
                        straight: false,
                        out_mode: "bounce",
                        bounce: false,
                        attract: {
                            enable: true,
                            rotateX: 1200,
                            rotateY: 1200
                        }
                    }
                },
                interactivity: {
                    detect_on: "canvas",
                    events: {
                        onhover: {
                            enable: !prefersReducedMotion,
                            mode: "grab"
                        },
                        onclick: {
                            enable: false,
                            mode: "push"
                        },
                        resize: true
                    },
                    modes: {
                        grab: {
                            distance: 150,
                            line_linked: {
                                opacity: 0.35
                            }
                        }
                    }
                },
                retina_detect: true
            });
        } catch (error) {
            console.error("particles.js initialization failed:", error);
        }
    } else if (!particlesEngine) {
        console.error("particles.js global was not found. Check CDN loading/network.");
    }

    const observerOptions = {
        threshold: 0.1,
        rootMargin: "0px 0px -100px 0px"
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
            if (entry.isIntersecting) {
                entry.target.classList.add("animate-in");
                observer.unobserve(entry.target);
            }
        });
    }, observerOptions);

    document.querySelectorAll(".story-card, .card").forEach((element) => {
        observer.observe(element);
    });
});
