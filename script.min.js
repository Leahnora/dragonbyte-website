document.addEventListener("DOMContentLoaded", async () => {
    const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
    const isMobile = window.matchMedia("(max-width: 768px)").matches || /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    const particlesEngine = window.particlesJS;
    const particlesHost = document.getElementById("bg");

    if (particlesEngine && particlesHost) {
        const particleCount = prefersReducedMotion ? 18 : (isMobile ? 36 : 64);
        const fpsLimit = prefersReducedMotion ? 18 : (isMobile ? 28 : 34);
        const linkDistance = isMobile ? 105 : 130;

        try {
            particlesEngine("bg", {
                fps_limit: fpsLimit,
                particles: {
                    number: {
                        value: particleCount,
                        density: {
                            enable: true,
                            value_area: isMobile ? 820 : 700
                        }
                    },
                    color: {
                        value: "#2100ee"
                    },
                    shape: {
                        type: "circle"
                    },
                    opacity: {
                        value: 0.5,
                        random: true,
                        anim: {
                            enable: true,
                            speed: 1.2,
                            opacity_min: 0.2,
                            sync: false
                        }
                    },
                    size: {
                        value: 2.4,
                        random: true,
                        anim: {
                            enable: true,
                            speed: 2,
                            size_min: 0.6,
                            sync: false
                        }
                    },
                    line_linked: {
                        enable: true,
                        distance: linkDistance,
                        color: "#1e3a8a",
                        opacity: 0.25,
                        width: 1
                    },
                    move: {
                        enable: true,
                        speed: isMobile ? 0.9 : 1.35,
                        direction: "none",
                        random: true,
                        straight: false,
                        out_mode: "bounce",
                        bounce: false,
                        attract: {
                            enable: true,
                            rotateX: 1200,
                            rotateY: 1200
                        }
                    }
                },
                interactivity: {
                    detect_on: "canvas",
                    events: {
                        onhover: {
                            enable: !prefersReducedMotion,
                            mode: "grab"
                        },
                        onclick: {
                            enable: false,
                            mode: "push"
                        },
                        resize: true
                    },
                    modes: {
                        grab: {
                            distance: 150,
                            line_linked: {
                                opacity: 0.35
                            }
                        }
                    }
                },
                retina_detect: true
            });
        } catch (error) {
            console.error("particles.js initialization failed:", error);
        }
    } else if (!particlesEngine) {
        console.error("particles.js global was not found. Check CDN loading/network.");
    }

    const observerOptions = {
        threshold: 0.1,
        rootMargin: "0px 0px -100px 0px"
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
            if (entry.isIntersecting) {
                entry.target.classList.add("animate-in");
                observer.unobserve(entry.target);
            }
        });
    }, observerOptions);

    document.querySelectorAll(".story-card, .card").forEach((element) => {
        observer.observe(element);
    });
});
